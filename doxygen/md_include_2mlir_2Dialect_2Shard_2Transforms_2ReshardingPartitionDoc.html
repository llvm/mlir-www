<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MLIR: Resharding Partition Examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MLIR<span id="projectnumber">&#160;22.0.0git</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search',false);
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Resharding Partition Examples </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md6"></a></p>
<p>Reshard <span class="tt">2x3</span> tensor from sharding <span class="tt">[[0, 1]]</span> to sharding <span class="tt">[[0, 1]]</span> on a <span class="tt">2x3</span> shard.</p>
<p>unsharded <span class="tt">2x3</span> tensor </p><div class="fragment"><div class="line">11 12 13</div>
<div class="line">21 22 23</div>
</div><!-- fragment --><p>sharded on a <span class="tt">2x3</span> grid</p>
<p>sharding = <span class="tt">[[0, 1]]</span></p>
<p>grid contents:</p>
<div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p>Transform into sharding = <span class="tt">[[1, 0]]</span> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 13 | 22 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 12 | 21 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p> Algorithm: Swap contents on devices that have the same linear index in the 2 shardings.</p>
<hr  />
<p>Reshard <span class="tt">2x3</span> tensor from sharding <span class="tt">[[0, 1]]</span> to sharding <span class="tt">[[1]]</span> on a <span class="tt">2x3</span> shard.</p>
<p>unsharded <span class="tt">2x3</span> tensor </p><div class="fragment"><div class="line">11 12 13</div>
<div class="line">21 22 23</div>
</div><!-- fragment --><p>sharded on a <span class="tt">2x3</span> grid</p>
<p>sharding = <span class="tt">[[0, 1]]</span></p>
<p>grid contents: </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p>Transform into sharding = <span class="tt">[[1]]</span> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p> Algorithm: All-gather along grid axis 0.</p>
<hr  />
<p>Reshard <span class="tt">4x6</span> tensor from sharding <span class="tt">[[], [0, 1]]</span> to sharding <span class="tt">[[], [0]]</span> on a <span class="tt">2x3</span> shard.</p>
<p>unsharded <span class="tt">4x6</span> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
</div><!-- fragment --><p>sharded on a <span class="tt">2x3</span> grid</p>
<p>sharding = <span class="tt">[[], [0, 1]]</span></p>
<p>grid contents: </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 14 | 15 | 16 |             |</div>
<div class="line">| 24 | 25 | 26 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p> Transform into sharding = <span class="tt">[[], [0]]</span> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+ grid axis 0 |</div>
<div class="line">| 11 12 13 | 11 12 13 |             |</div>
<div class="line">| 21 22 23 | 21 22 23 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 14 15 16 | 14 15 16 |             |</div>
<div class="line">| 24 25 26 | 24 25 26 |             |</div>
<div class="line">+----------+----------+             ↓</div>
</div><!-- fragment --><p> Algorithm: All-gather along grid axis 1.</p>
<hr  />
<p>Reshard <span class="tt">4x8</span> tensor from sharding <span class="tt">[[0], [1, 2]]</span> to sharding <span class="tt">[[0], [2]]</span> on a <span class="tt">2x2x2</span> shard.</p>
<p>unsharded <span class="tt">4x8</span> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16 17 18</div>
<div class="line">21 22 23 24 25 26 27 28</div>
<div class="line">31 32 33 34 35 36 37 38</div>
<div class="line">41 42 43 44 45 46 47 48</div>
</div><!-- fragment --><p> sharded on a <span class="tt">2x2x2</span> grid</p>
<p>sharding = <span class="tt">[[0], [1, 2]]</span></p>
<p>grid contents: </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 12 | 13 14 |             |             |</div>
<div class="line">| 21 22 | 23 24 |             |             |</div>
<div class="line">+-------+-------+             |             |</div>
<div class="line">| 15 16 | 17 18 |             |             |</div>
<div class="line">| 25 26 | 27 28 |             |             |</div>
<div class="line">+-------+-------+             ↓             |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 31 32 | 33 34 |                           |</div>
<div class="line">| 41 42 | 43 44 |                           |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 35 36 | 37 38 |                           |</div>
<div class="line">| 45 46 | 47 48 |                           |</div>
<div class="line">+-------+-------+                           ↓</div>
</div><!-- fragment --><p> Transform into sharding = <span class="tt">[[0], [2]]</span> </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------------+-------------+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 12 13 14 | 15 16 17 18 |             |             |</div>
<div class="line">| 21 22 23 24 | 25 26 27 28 |             |             |</div>
<div class="line">+-------------+-------------+             |             |</div>
<div class="line">| 11 12 13 14 | 15 16 17 18 |             |             |</div>
<div class="line">| 21 22 23 24 | 25 26 27 28 |             |             |</div>
<div class="line">+-------------+-------------+             ↓             |</div>
<div class="line">+-------------+-------------+                           |</div>
<div class="line">| 31 32 33 34 | 35 36 37 38 |                           |</div>
<div class="line">| 41 42 43 44 | 45 46 47 48 |                           |</div>
<div class="line">+-------------+-------------+                           |</div>
<div class="line">| 31 32 33 34 | 35 36 37 38 |                           |</div>
<div class="line">| 41 42 43 44 | 45 46 47 48 |                           |</div>
<div class="line">+-------------+-------------+                           ↓</div>
</div><!-- fragment --><p> Algorithm:</p>
<p>Can't be done with just an all-gather along grid axis 1. Can be handled by multiple resharding transformations <span class="tt">[[0], [1, 2]] -&gt; [[0], [2, 1]] -&gt; [[0], [2]]</span></p>
<hr  />
<p>Reshard <span class="tt">6x6</span> tensor from sharding <span class="tt">[[0], [1]]</span> to sharding <span class="tt">[[1], [0]]</span> on a <span class="tt">2x3</span> shard.</p>
<p>unsharded <span class="tt">6x6</span> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
<div class="line">31 32 33 34 35 36</div>
<div class="line">41 42 43 44 45 46</div>
<div class="line">51 52 53 54 55 56</div>
<div class="line">61 62 63 64 65 66</div>
</div><!-- fragment --><p> sharded on a <span class="tt">2x3</span> grid</p>
<p>sharding = <span class="tt">[[0], [1]]</span> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+-------+ grid axis 0 |</div>
<div class="line">| 11 12 | 13 14 | 15 16 |             |</div>
<div class="line">| 21 22 | 23 24 | 25 26 |             |</div>
<div class="line">| 31 32 | 33 34 | 35 36 |             |</div>
<div class="line">+-------+-------+-------+             |</div>
<div class="line">| 41 42 | 43 44 | 45 46 |             |</div>
<div class="line">| 51 52 | 53 54 | 55 56 |             |</div>
<div class="line">| 61 62 | 63 64 | 65 66 |             |</div>
<div class="line">+-------+-------+-------+             ↓</div>
</div><!-- fragment --><p> transform to sharding = <span class="tt">[[1], [0]]</span> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+----------+ grid axis 0 |</div>
<div class="line">| 11 12 13 | 31 32 33 | 51 52 53 |             |</div>
<div class="line">| 21 22 23 | 41 42 43 | 61 62 63 |             |</div>
<div class="line">+----------+----------+----------+             |</div>
<div class="line">| 14 15 16 | 34 35 36 | 54 55 56 |             |</div>
<div class="line">| 24 25 26 | 44 45 46 | 64 65 66 |             |</div>
<div class="line">+----------+----------+----------+             ↓</div>
<div class="line"> </div>
<div class="line">grid axis 0</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+ grid axis 1 |</div>
<div class="line">| 11 12 13 | 14 15 16 |             |</div>
<div class="line">| 21 22 23 | 24 25 26 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 31 32 33 | 34 35 36 |             |</div>
<div class="line">| 41 42 43 | 44 45 46 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 51 52 53 | 54 55 56 |             |</div>
<div class="line">| 61 62 63 | 64 65 66 |             |</div>
<div class="line">+----------+----------+             ↓</div>
</div><!-- fragment --><p> Algorithm: TODO</p>
<hr  />
<p>Reshard <span class="tt">6x6</span> tensor from sharding <span class="tt">[[0], [1]]</span> to sharding <span class="tt">[[1], [0]]</span> on a <span class="tt">2x6</span> shard.</p>
<p>unsharded 6x6 tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
<div class="line">31 32 33 34 35 36</div>
<div class="line">41 42 43 44 45 46</div>
<div class="line">51 52 53 54 55 56</div>
<div class="line">61 62 63 64 65 66</div>
</div><!-- fragment --><p> shard on <span class="tt">2x6</span> grid</p>
<p>sharding = <span class="tt">[[0], [1]]</span> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 ‖ 14 | 15 | 16 |             |</div>
<div class="line">| 21 | 22 | 23 ‖ 24 | 23 | 26 |             |</div>
<div class="line">| 31 | 32 | 33 ‖ 34 | 35 | 36 |             |</div>
<div class="line">+----+----+----+----+----+----+             |</div>
<div class="line">| 41 | 42 | 43 ‖ 44 | 45 | 46 |             |</div>
<div class="line">| 51 | 52 | 53 ‖ 54 | 55 | 56 |             |</div>
<div class="line">| 61 | 62 | 63 ‖ 64 | 65 | 66 |             |</div>
<div class="line">+----+----+----+----+----+----+             ↓</div>
</div><!-- fragment --><p> transform to sharding = <span class="tt">[[1], [0]]</span> </p><div class="fragment"><div class="line">grid axis 0</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+ grid axis 1 |</div>
<div class="line">| 11 12 13 | 14 15 16 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 21 22 23 | 24 25 26 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 31 32 33 | 34 35 36 |             |</div>
<div class="line">+==========+==========+             |</div>
<div class="line">| 41 42 43 | 44 45 46 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 51 52 53 | 54 55 56 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 61 62 63 | 64 65 66 |             |</div>
<div class="line">+----------+----------+             ↓</div>
</div><!-- fragment --><p> Algorithm: TODO</p>
<hr  />
<p>Reshard KxL tensor from <span class="tt">[[0], [1]]</span> to <span class="tt">[[1], [0]]</span> on <span class="tt">MxN</span> shard.</p>
<p><span class="tt">M x N</span> shard. <span class="tt">K x L</span> tensor <span class="tt">t</span>. <span class="tt">d(m, n)</span> the tensor on device <span class="tt">(m, n)</span>.</p>
<p>sharding = <span class="tt">[[0], [1]]</span> Tensor shard s on each device has size <span class="tt">(K ceildiv M, L ceildiv N)</span>. </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[m * (K ceildiv M) + k, n * (L ceildiv N) + l]</div>
</div><!-- fragment --><p> substitute </p><div class="fragment"><div class="line">i &lt;- m * (K ceildiv M) + k</div>
<div class="line">j &lt;- n * (L ceildiv N) + l</div>
</div><!-- fragment --> <div class="fragment"><div class="line">m -&gt; i floordiv (K ceildiv M)</div>
<div class="line">n -&gt; j floordiv (L ceildiv N)</div>
<div class="line">k -&gt; i % (K ceildiv M)</div>
<div class="line">l -&gt; j % (L ceildiv N)</div>
</div><!-- fragment --><p> For the inverse map we get </p><div class="fragment"><div class="line">t[i, j] -&gt; d(</div>
<div class="line">    i floordiv (K ceildiv M), j floordiv (L ceildiv N)</div>
<div class="line">)[</div>
<div class="line">    i % (K ceildiv M), j % (L ceildiv N)</div>
<div class="line">]</div>
</div><!-- fragment --><p> Check: </p><div class="fragment"><div class="line">i = 13, j = 17, M = 3, N = 4, K = 16, L = 23</div>
<div class="line">t[13, 17] = d(</div>
<div class="line">    13 floordiv (16 ceildiv 3),</div>
<div class="line">    17 floordiv (23 ceilvid 4)</div>
<div class="line">)[</div>
<div class="line">    13 % (16 ceildiv 3),</div>
<div class="line">    17 % (23 ceilvid 4)</div>
<div class="line">]</div>
<div class="line">= d(</div>
<div class="line">    13 floordiv 6,</div>
<div class="line">    17 floordiv 6</div>
<div class="line">)[</div>
<div class="line">    13 % 6,</div>
<div class="line">    17 % 6</div>
<div class="line">]</div>
<div class="line">= d(2, 2)[1, 5]</div>
<div class="line">= t[</div>
<div class="line">    2 * (16 ceildiv 3) + 1,</div>
<div class="line">    2 * (23 ceildiv 4) + 5</div>
<div class="line">]</div>
<div class="line">= t[</div>
<div class="line">    2 * 6 + 1,</div>
<div class="line">    2 * 6 + 5</div>
<div class="line">]</div>
<div class="line">= t[13, 17]</div>
</div><!-- fragment --><p>sharding = <span class="tt">[[1], [0]]</span> Tensor shard s on each device has size <span class="tt">(K ceildiv N, L ceildiv M)</span>. </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[n * (K ceildiv N) + k, m * (L ceildiv M) + l]</div>
</div><!-- fragment --><p> substitute </p><div class="fragment"><div class="line">i &lt;- n * (K ceildiv N) + k</div>
<div class="line">j &lt;- m * (L ceildiv M) + l</div>
</div><!-- fragment --> <div class="fragment"><div class="line">m -&gt; j floordiv (L ceildiv M)</div>
<div class="line">n -&gt; i floordiv (K ceildiv N)</div>
<div class="line">k -&gt; i % (K ceildiv N)</div>
<div class="line">l -&gt; j % (L ceildiv M)</div>
</div><!-- fragment --><p> For the inverse map we get </p><div class="fragment"><div class="line">t[i, j] -&gt; d(</div>
<div class="line">    j floordiv (L ceildiv M), i floordiv (K ceildiv N)</div>
<div class="line">)[</div>
<div class="line">    i % (K ceildiv N), j % (L ceildiv M)</div>
<div class="line">]</div>
</div><!-- fragment --><p> Check: </p><div class="fragment"><div class="line">i = 9, j = 19, M = 5, N = 2, K = 27, L = 14</div>
<div class="line">t[9, 19] = d(</div>
<div class="line">    19 floordiv (14 ceildiv 5),</div>
<div class="line">    9 floordiv (27 ceildiv 2)</div>
<div class="line">)[</div>
<div class="line">    9 % (27 ceildiv 2),</div>
<div class="line">    19 % (14 ceildiv 5)</div>
<div class="line">]</div>
<div class="line">= d(</div>
<div class="line">    19 floordiv 3,</div>
<div class="line">    9 floordiv 14</div>
<div class="line">)[</div>
<div class="line">    9 % 14</div>
<div class="line">    19 % 3</div>
<div class="line">]</div>
<div class="line">= d(6, 0)[9, 1]</div>
<div class="line">= t[</div>
<div class="line">    0 * (27 ceildiv 2) + 9,</div>
<div class="line">    6 * (14 ceildiv 5) + 1</div>
<div class="line">]</div>
<div class="line">= t[</div>
<div class="line">    0 * 14 + 9,</div>
<div class="line">    6 * 3 + 1</div>
<div class="line">]</div>
<div class="line">= t[9, 19]</div>
</div><!-- fragment --><p> sharding = <span class="tt">[[0], [1]]</span> </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[m * (K ceildiv M) + k, n * (L ceildiv N) + l]</div>
<div class="line">t[i, j] -&gt; d(i floordiv (K ceildiv M), j floordiv (L ceildiv N))[i % (K ceildiv M), j % (L ceildiv N)]</div>
</div><!-- fragment --><p> sharding = <span class="tt">[[1], [0]]</span> </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[n * (K ceildiv N) + k, m * (L ceildiv M) + l]</div>
<div class="line">t[i, j] -&gt; d(j floordiv (L ceildiv M), i floordiv (K ceildiv N))[i % (K ceildiv N), j % (L ceildiv M)]</div>
</div><!-- fragment --><p> sharding <span class="tt">[[0], [1]] -&gt; [[1], [0]]</span> <span class="tt">d1(m, n)</span> the tensor on device <span class="tt">(m, n)</span> for sharding sharding <span class="tt">[[0], [1]]</span>. <span class="tt">d2(m, n)</span> the tensor on device <span class="tt">(m, n)</span> for sharding sharding <span class="tt">[[1], [0]]</span>. </p><div class="fragment"><div class="line">d1(m, n)[k, l] -&gt;</div>
<div class="line">t[m * (K ceildiv M) + k, n * (L ceildiv N) + l] -&gt;</div>
<div class="line">d2(</div>
<div class="line">    (m * (L ceildiv M) + l) floordiv (L ceildiv M),</div>
<div class="line">    (n * (K ceildiv N) + k) floordiv (K ceildiv N)</div>
<div class="line">)[</div>
<div class="line">    (n * (K ceildiv N) + k) % (K ceildiv N),</div>
<div class="line">    (m * (L ceildiv M) + l) % (L ceildiv M)</div>
<div class="line">]</div>
<div class="line">= d2(p, q)[u, v]</div>
</div><!-- fragment --><p> We want to copy the the data between devices in slices/tiles. What are the source/target tile coordinates? For a fixed <span class="tt">(m, n, p, q)</span> what is the range of <span class="tt">(k, l, u, v)</span>? TODO</p>
<hr  />
<p>Reshard <span class="tt">KxL</span> tensor from sharding <span class="tt">[[0], [1]]</span> to sharding <span class="tt">[[1], [0]]</span> on a <span class="tt">2x3</span> shard.</p>
<p>Device placement on a <span class="tt">2x3</span> grid </p><div class="fragment"><div class="line">11 12 13  &lt;- devices</div>
<div class="line">21 22 23</div>
</div><!-- fragment --><p> sharding <span class="tt">[[0], [1]]</span> </p><div class="fragment"><div class="line">tensor axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ tensor axis 0 |</div>
<div class="line">| 11 | 12 | 13 |               |</div>
<div class="line">+----+----+----+               |</div>
<div class="line">| 21 | 22 | 23 |               |</div>
<div class="line">+----+----+----+               ↓</div>
</div><!-- fragment --><p> transform to sharding <span class="tt">[[1], [0]]</span> </p><div class="fragment"><div class="line">tensor axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+ tensor axis 0 |</div>
<div class="line">| 11 | 21 |               |</div>
<div class="line">+----+----+               |</div>
<div class="line">| 12 | 22 |               |</div>
<div class="line">+----+----+               |</div>
<div class="line">| 13 | 23 |               |</div>
<div class="line">+----+----+               ↓</div>
</div><!-- fragment --> <div class="fragment"><div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|       11        |        12       |        13       |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|       21        |        22       |        23       |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line"> </div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                          |                          |</div>
<div class="line">+          11              +               21         +</div>
<div class="line">|                          |                          |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                          |                          |</div>
<div class="line">+          12              +               22         +</div>
<div class="line">|                          |                          |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                          |                          |</div>
<div class="line">+          13              +               23         +</div>
<div class="line">|                          |                          |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line"> </div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+     11  11      + 12  11 + 12  21 +     13  21      +</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|     11  12      | 12  12 | 12  22 |     13  22      |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|     21  12      | 22  12 | 22  22 |     23  22      |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+     21  13      + 22  13 + 22  23 +     23  23      +</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
</div><!-- fragment --><p> If <span class="tt">S</span> and <span class="tt">T</span> are the source and target shard sizes along some tensor axis. Then we have a period of <span class="tt">(S*T)/gcd(S, T)</span>. Then the cut pattern repeats. TODO</p>
<hr  />
<p>Reshard <span class="tt">6x6</span> tensor from sharding <span class="tt">[[0], []]</span> to sharding <span class="tt">[[], [0]]</span> on a <span class="tt">3</span> shard.</p>
<p>unsharded <span class="tt">6x6</span> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
<div class="line">31 32 33 34 35 36</div>
<div class="line">41 42 43 44 45 46</div>
<div class="line">51 52 53 54 55 56</div>
<div class="line">61 62 63 64 65 66</div>
</div><!-- fragment --><p> sharded on a <span class="tt">3</span> grid</p>
<p>sharding = <span class="tt">[[0], []]</span> </p><div class="fragment"><div class="line">+-------------------+ grid axis 0 |</div>
<div class="line">| 11 12 13 14 15 16 |             |</div>
<div class="line">| 21 22 23 24 25 26 |             |</div>
<div class="line">+-------------------+             |</div>
<div class="line">| 31 32 33 34 35 36 |             |</div>
<div class="line">| 41 42 43 44 45 46 |             |</div>
<div class="line">+-------------------+             |</div>
<div class="line">| 51 52 53 54 55 56 |             |</div>
<div class="line">| 61 62 63 64 65 66 |             |</div>
<div class="line">+-------------------+             ↓</div>
</div><!-- fragment --><p> transform to sharding = <span class="tt">[[], [0]]</span> </p><div class="fragment"><div class="line">grid axis 0</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+-------+</div>
<div class="line">| 11 12 | 13 14 | 15 16 |</div>
<div class="line">| 21 22 | 23 24 | 25 26 |</div>
<div class="line">| 31 32 | 33 34 | 35 36 |</div>
<div class="line">| 41 42 | 43 44 | 45 46 |</div>
<div class="line">| 51 52 | 53 54 | 55 56 |</div>
<div class="line">| 61 62 | 63 64 | 65 66 |</div>
<div class="line">+-------+-------+-------+</div>
</div><!-- fragment --><p> Algorithm: </p><div class="fragment"><div class="line">%1 = all_to_all %0 on @grid grid_axes = [0] split_axis = 1 concat_axis = 0 : tensor&lt;2x6xi8&gt; -&gt; tensor&lt;6x2xi8&gt;</div>
</div><!-- fragment --> <hr  />
<p>Reshard <span class="tt">4x4</span> tensor from sharding <span class="tt">[[0], [1, 2]]</span> to sharding <span class="tt">[[0, 1], [2]]</span> on a <span class="tt">2x2x2</span> shard.</p>
<p>unsharded <span class="tt">4x4</span> tensor </p><div class="fragment"><div class="line">11 12 13 14</div>
<div class="line">21 22 23 24</div>
<div class="line">31 32 33 34</div>
<div class="line">41 42 43 44</div>
</div><!-- fragment --><p> sharded on a <span class="tt">2x2x2</span> grid</p>
<p>sharding = <span class="tt">[[0], [1, 2]]</span> </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 | 12 |             |             |</div>
<div class="line">| 21 | 22 |             |             |</div>
<div class="line">+----+----+             |             |</div>
<div class="line">| 13 | 14 |             |             |</div>
<div class="line">| 23 | 24 |             |             |</div>
<div class="line">+----+----+             ↓             |</div>
<div class="line">+----+----+                           |</div>
<div class="line">| 31 | 32 |                           |</div>
<div class="line">| 41 | 42 |                           |</div>
<div class="line">+----+----+                           |</div>
<div class="line">| 33 | 34 |                           |</div>
<div class="line">| 43 | 44 |                           |</div>
<div class="line">+----+----+                           ↓</div>
</div><!-- fragment --><p> transform to sharding = <span class="tt">[[0, 1], [2]]</span> </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 12 | 13 41 |             |             |</div>
<div class="line">+-------+-------+             |             |</div>
<div class="line">| 21 22 | 23 24 |             |             |</div>
<div class="line">+-------+-------+             ↓             |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 31 32 | 33 34 |                           |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 41 42 | 43 44 |                           |</div>
<div class="line">+-------+-------+                           ↓</div>
</div><!-- fragment --><p> Algorithm: </p><div class="fragment"><div class="line">%1 = all_to_all %0 on @grid grid_axes = [2] split_axis = 1 concat_axis = 0 : tensor&lt;2x1xi8&gt; -&gt; tensor&lt;1x2xi8&gt;</div>
</div><!-- fragment --><p> is not enough.</p>
<p>Can be decomposed into </p><div class="fragment"><div class="line">[[0], [1, 2]] -&gt; [[0], [2, 1]] -&gt; [[0, 1], [2]]</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
Decomposition into basis of reshardings</h1>
<p>We can decompose each resharding into a sequence of basis reshardings. It is not communication efficient in terms of minimizing the data communicated between devices. An efficient approach would be more complicated to implement. Each device has to receive at most as much data as the size of its target sharding tensor.</p>
<hr  />
<p>Basis:</p>
<ul>
<li>From replicate to split. <span class="tt">
    [[]] -&gt; [[1]]
    </span> Extract slices without communication.</li>
<li>From split to replicate. <div class="fragment"><div class="line">[[0]] -&gt; [[]]</div>
<div class="line">[[0, 1]] -&gt; [[1]]</div>
</div><!-- fragment --> All-gather along grid axis 0.</li>
<li>Swap grid axes order when assigned to the same tensor axis. <span class="tt">
    [[0, 1]] -&gt; [[1, 0]]
    </span> Swap contents on devices with the same linear index.</li>
<li>Move grid axis to different tensor dimension. <span class="tt">
    [[0], []] -&gt; [[], [0]]
    </span> All-to-all.</li>
</ul>
<hr  />
<p>Example decomposition of </p><div class="fragment"><div class="line">[[0], [1]] -&gt; [[1], [0]]</div>
</div><!-- fragment --><p> into </p><div class="fragment"><div class="line">[[0], [1]] -&gt; all-gather along grid axis 1    -&gt;</div>
<div class="line">[[0], []]  -&gt; all-to-all along grid axis 0    -&gt;</div>
<div class="line">[[], [0]]  -&gt; extract slice along grid axis 1 -&gt;</div>
<div class="line">[[1], [0]]</div>
</div><!-- fragment --><hr  />
<p>Example decomposition of </p><div class="fragment"><div class="line">[[3, 2], [], [0, 1]] -&gt; [[0], [1, 2], []]</div>
</div><!-- fragment --><p> into </p><div class="fragment"><div class="line">[[3, 2], [], [0, 1]] -&gt; all-to-all along grid axis 1 -&gt;</div>
<div class="line">[[3, 2], [1], [0]]   -&gt; all-to-all along grid axis 2 -&gt;</div>
<div class="line">[[3], [1, 2], [0]]   -&gt; all-gather along grid axis 3 -&gt;</div>
<div class="line">[[], [1, 2], [0]]    -&gt; all-to-all along grid axis 0 -&gt;</div>
<div class="line">[[0], [1, 2], []]</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on <span class="timestamp"></span> for MLIR by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
