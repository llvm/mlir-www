<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MLIR: Resharding Partition Examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MLIR
   &#160;<span id="projectnumber">22.0.0git</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Resharding Partition Examples </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Reshard <code>2x3</code> tensor from sharding <code>[[0, 1]]</code> to sharding <code>[[0, 1]]</code> on a <code>2x3</code> shard.</p>
<p>unsharded <code>2x3</code> tensor </p><div class="fragment"><div class="line">11 12 13</div>
<div class="line">21 22 23</div>
</div><!-- fragment --><p>sharded on a <code>2x3</code> grid</p>
<p>sharding = <code>[[0, 1]]</code></p>
<p>grid contents:</p>
<div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p>Transform into sharding = <code>[[1, 0]]</code> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 13 | 22 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 12 | 21 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p> Algorithm: Swap contents on devices that have the same linear index in the 2 shardings.</p>
<hr  />
<p>Reshard <code>2x3</code> tensor from sharding <code>[[0, 1]]</code> to sharding <code>[[1]]</code> on a <code>2x3</code> shard.</p>
<p>unsharded <code>2x3</code> tensor </p><div class="fragment"><div class="line">11 12 13</div>
<div class="line">21 22 23</div>
</div><!-- fragment --><p>sharded on a <code>2x3</code> grid</p>
<p>sharding = <code>[[0, 1]]</code></p>
<p>grid contents: </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p>Transform into sharding = <code>[[1]]</code> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p> Algorithm: All-gather along grid axis 0.</p>
<hr  />
<p>Reshard <code>4x6</code> tensor from sharding <code>[[], [0, 1]]</code> to sharding <code>[[], [0]]</code> on a <code>2x3</code> shard.</p>
<p>unsharded <code>4x6</code> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
</div><!-- fragment --><p>sharded on a <code>2x3</code> grid</p>
<p>sharding = <code>[[], [0, 1]]</code></p>
<p>grid contents: </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 |             |</div>
<div class="line">| 21 | 22 | 23 |             |</div>
<div class="line">+----+----+----+             |</div>
<div class="line">| 14 | 15 | 16 |             |</div>
<div class="line">| 24 | 25 | 26 |             |</div>
<div class="line">+----+----+----+             ↓</div>
</div><!-- fragment --><p> Transform into sharding = <code>[[], [0]]</code> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+ grid axis 0 |</div>
<div class="line">| 11 12 13 | 11 12 13 |             |</div>
<div class="line">| 21 22 23 | 21 22 23 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 14 15 16 | 14 15 16 |             |</div>
<div class="line">| 24 25 26 | 24 25 26 |             |</div>
<div class="line">+----------+----------+             ↓</div>
</div><!-- fragment --><p> Algorithm: All-gather along grid axis 1.</p>
<hr  />
<p>Reshard <code>4x8</code> tensor from sharding <code>[[0], [1, 2]]</code> to sharding <code>[[0], [2]]</code> on a <code>2x2x2</code> shard.</p>
<p>unsharded <code>4x8</code> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16 17 18</div>
<div class="line">21 22 23 24 25 26 27 28</div>
<div class="line">31 32 33 34 35 36 37 38</div>
<div class="line">41 42 43 44 45 46 47 48</div>
</div><!-- fragment --><p> sharded on a <code>2x2x2</code> grid</p>
<p>sharding = <code>[[0], [1, 2]]</code></p>
<p>grid contents: </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 12 | 13 14 |             |             |</div>
<div class="line">| 21 22 | 23 24 |             |             |</div>
<div class="line">+-------+-------+             |             |</div>
<div class="line">| 15 16 | 17 18 |             |             |</div>
<div class="line">| 25 26 | 27 28 |             |             |</div>
<div class="line">+-------+-------+             ↓             |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 31 32 | 33 34 |                           |</div>
<div class="line">| 41 42 | 43 44 |                           |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 35 36 | 37 38 |                           |</div>
<div class="line">| 45 46 | 47 48 |                           |</div>
<div class="line">+-------+-------+                           ↓</div>
</div><!-- fragment --><p> Transform into sharding = <code>[[0], [2]]</code> </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------------+-------------+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 12 13 14 | 15 16 17 18 |             |             |</div>
<div class="line">| 21 22 23 24 | 25 26 27 28 |             |             |</div>
<div class="line">+-------------+-------------+             |             |</div>
<div class="line">| 11 12 13 14 | 15 16 17 18 |             |             |</div>
<div class="line">| 21 22 23 24 | 25 26 27 28 |             |             |</div>
<div class="line">+-------------+-------------+             ↓             |</div>
<div class="line">+-------------+-------------+                           |</div>
<div class="line">| 31 32 33 34 | 35 36 37 38 |                           |</div>
<div class="line">| 41 42 43 44 | 45 46 47 48 |                           |</div>
<div class="line">+-------------+-------------+                           |</div>
<div class="line">| 31 32 33 34 | 35 36 37 38 |                           |</div>
<div class="line">| 41 42 43 44 | 45 46 47 48 |                           |</div>
<div class="line">+-------------+-------------+                           ↓</div>
</div><!-- fragment --><p> Algorithm:</p>
<p>Can't be done with just an all-gather along grid axis 1. Can be handled by multiple resharding transformations <code>[[0], [1, 2]] -&gt; [[0], [2, 1]] -&gt; [[0], [2]]</code></p>
<hr  />
<p>Reshard <code>6x6</code> tensor from sharding <code>[[0], [1]]</code> to sharding <code>[[1], [0]]</code> on a <code>2x3</code> shard.</p>
<p>unsharded <code>6x6</code> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
<div class="line">31 32 33 34 35 36</div>
<div class="line">41 42 43 44 45 46</div>
<div class="line">51 52 53 54 55 56</div>
<div class="line">61 62 63 64 65 66</div>
</div><!-- fragment --><p> sharded on a <code>2x3</code> grid</p>
<p>sharding = <code>[[0], [1]]</code> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+-------+ grid axis 0 |</div>
<div class="line">| 11 12 | 13 14 | 15 16 |             |</div>
<div class="line">| 21 22 | 23 24 | 25 26 |             |</div>
<div class="line">| 31 32 | 33 34 | 35 36 |             |</div>
<div class="line">+-------+-------+-------+             |</div>
<div class="line">| 41 42 | 43 44 | 45 46 |             |</div>
<div class="line">| 51 52 | 53 54 | 55 56 |             |</div>
<div class="line">| 61 62 | 63 64 | 65 66 |             |</div>
<div class="line">+-------+-------+-------+             ↓</div>
</div><!-- fragment --><p> transform to sharding = <code>[[1], [0]]</code> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+----------+ grid axis 0 |</div>
<div class="line">| 11 12 13 | 31 32 33 | 51 52 53 |             |</div>
<div class="line">| 21 22 23 | 41 42 43 | 61 62 63 |             |</div>
<div class="line">+----------+----------+----------+             |</div>
<div class="line">| 14 15 16 | 34 35 36 | 54 55 56 |             |</div>
<div class="line">| 24 25 26 | 44 45 46 | 64 65 66 |             |</div>
<div class="line">+----------+----------+----------+             ↓</div>
<div class="line"> </div>
<div class="line">grid axis 0</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+ grid axis 1 |</div>
<div class="line">| 11 12 13 | 14 15 16 |             |</div>
<div class="line">| 21 22 23 | 24 25 26 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 31 32 33 | 34 35 36 |             |</div>
<div class="line">| 41 42 43 | 44 45 46 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 51 52 53 | 54 55 56 |             |</div>
<div class="line">| 61 62 63 | 64 65 66 |             |</div>
<div class="line">+----------+----------+             ↓</div>
</div><!-- fragment --><p> Algorithm: TODO</p>
<hr  />
<p>Reshard <code>6x6</code> tensor from sharding <code>[[0], [1]]</code> to sharding <code>[[1], [0]]</code> on a <code>2x6</code> shard.</p>
<p>unsharded 6x6 tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
<div class="line">31 32 33 34 35 36</div>
<div class="line">41 42 43 44 45 46</div>
<div class="line">51 52 53 54 55 56</div>
<div class="line">61 62 63 64 65 66</div>
</div><!-- fragment --><p> shard on <code>2x6</code> grid</p>
<p>sharding = <code>[[0], [1]]</code> </p><div class="fragment"><div class="line">grid axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+----+----+----+ grid axis 0 |</div>
<div class="line">| 11 | 12 | 13 ‖ 14 | 15 | 16 |             |</div>
<div class="line">| 21 | 22 | 23 ‖ 24 | 23 | 26 |             |</div>
<div class="line">| 31 | 32 | 33 ‖ 34 | 35 | 36 |             |</div>
<div class="line">+----+----+----+----+----+----+             |</div>
<div class="line">| 41 | 42 | 43 ‖ 44 | 45 | 46 |             |</div>
<div class="line">| 51 | 52 | 53 ‖ 54 | 55 | 56 |             |</div>
<div class="line">| 61 | 62 | 63 ‖ 64 | 65 | 66 |             |</div>
<div class="line">+----+----+----+----+----+----+             ↓</div>
</div><!-- fragment --><p> transform to sharding = <code>[[1], [0]]</code> </p><div class="fragment"><div class="line">grid axis 0</div>
<div class="line">-----------&gt;</div>
<div class="line">+----------+----------+ grid axis 1 |</div>
<div class="line">| 11 12 13 | 14 15 16 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 21 22 23 | 24 25 26 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 31 32 33 | 34 35 36 |             |</div>
<div class="line">+==========+==========+             |</div>
<div class="line">| 41 42 43 | 44 45 46 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 51 52 53 | 54 55 56 |             |</div>
<div class="line">+----------+----------+             |</div>
<div class="line">| 61 62 63 | 64 65 66 |             |</div>
<div class="line">+----------+----------+             ↓</div>
</div><!-- fragment --><p> Algorithm: TODO</p>
<hr  />
<p>Reshard KxL tensor from <code>[[0], [1]]</code> to <code>[[1], [0]]</code> on <code>MxN</code> shard.</p>
<p><code>M x N</code> shard. <code>K x L</code> tensor <code>t</code>. <code>d(m, n)</code> the tensor on device <code>(m, n)</code>.</p>
<p>sharding = <code>[[0], [1]]</code> Tensor shard s on each device has size <code>(K ceildiv M, L ceildiv N)</code>. </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[m * (K ceildiv M) + k, n * (L ceildiv N) + l]</div>
</div><!-- fragment --><p> substitute </p><div class="fragment"><div class="line">i &lt;- m * (K ceildiv M) + k</div>
<div class="line">j &lt;- n * (L ceildiv N) + l</div>
</div><!-- fragment --> <div class="fragment"><div class="line">m -&gt; i floordiv (K ceildiv M)</div>
<div class="line">n -&gt; j floordiv (L ceildiv N)</div>
<div class="line">k -&gt; i % (K ceildiv M)</div>
<div class="line">l -&gt; j % (L ceildiv N)</div>
</div><!-- fragment --><p> For the inverse map we get </p><div class="fragment"><div class="line">t[i, j] -&gt; d(</div>
<div class="line">    i floordiv (K ceildiv M), j floordiv (L ceildiv N)</div>
<div class="line">)[</div>
<div class="line">    i % (K ceildiv M), j % (L ceildiv N)</div>
<div class="line">]</div>
</div><!-- fragment --><p> Check: </p><div class="fragment"><div class="line">i = 13, j = 17, M = 3, N = 4, K = 16, L = 23</div>
<div class="line">t[13, 17] = d(</div>
<div class="line">    13 floordiv (16 ceildiv 3),</div>
<div class="line">    17 floordiv (23 ceilvid 4)</div>
<div class="line">)[</div>
<div class="line">    13 % (16 ceildiv 3),</div>
<div class="line">    17 % (23 ceilvid 4)</div>
<div class="line">]</div>
<div class="line">= d(</div>
<div class="line">    13 floordiv 6,</div>
<div class="line">    17 floordiv 6</div>
<div class="line">)[</div>
<div class="line">    13 % 6,</div>
<div class="line">    17 % 6</div>
<div class="line">]</div>
<div class="line">= d(2, 2)[1, 5]</div>
<div class="line">= t[</div>
<div class="line">    2 * (16 ceildiv 3) + 1,</div>
<div class="line">    2 * (23 ceildiv 4) + 5</div>
<div class="line">]</div>
<div class="line">= t[</div>
<div class="line">    2 * 6 + 1,</div>
<div class="line">    2 * 6 + 5</div>
<div class="line">]</div>
<div class="line">= t[13, 17]</div>
</div><!-- fragment --><p>sharding = <code>[[1], [0]]</code> Tensor shard s on each device has size <code>(K ceildiv N, L ceildiv M)</code>. </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[n * (K ceildiv N) + k, m * (L ceildiv M) + l]</div>
</div><!-- fragment --><p> substitute </p><div class="fragment"><div class="line">i &lt;- n * (K ceildiv N) + k</div>
<div class="line">j &lt;- m * (L ceildiv M) + l</div>
</div><!-- fragment --> <div class="fragment"><div class="line">m -&gt; j floordiv (L ceildiv M)</div>
<div class="line">n -&gt; i floordiv (K ceildiv N)</div>
<div class="line">k -&gt; i % (K ceildiv N)</div>
<div class="line">l -&gt; j % (L ceildiv M)</div>
</div><!-- fragment --><p> For the inverse map we get </p><div class="fragment"><div class="line">t[i, j] -&gt; d(</div>
<div class="line">    j floordiv (L ceildiv M), i floordiv (K ceildiv N)</div>
<div class="line">)[</div>
<div class="line">    i % (K ceildiv N), j % (L ceildiv M)</div>
<div class="line">]</div>
</div><!-- fragment --><p> Check: </p><div class="fragment"><div class="line">i = 9, j = 19, M = 5, N = 2, K = 27, L = 14</div>
<div class="line">t[9, 19] = d(</div>
<div class="line">    19 floordiv (14 ceildiv 5),</div>
<div class="line">    9 floordiv (27 ceildiv 2)</div>
<div class="line">)[</div>
<div class="line">    9 % (27 ceildiv 2),</div>
<div class="line">    19 % (14 ceildiv 5)</div>
<div class="line">]</div>
<div class="line">= d(</div>
<div class="line">    19 floordiv 3,</div>
<div class="line">    9 floordiv 14</div>
<div class="line">)[</div>
<div class="line">    9 % 14</div>
<div class="line">    19 % 3</div>
<div class="line">]</div>
<div class="line">= d(6, 0)[9, 1]</div>
<div class="line">= t[</div>
<div class="line">    0 * (27 ceildiv 2) + 9,</div>
<div class="line">    6 * (14 ceildiv 5) + 1</div>
<div class="line">]</div>
<div class="line">= t[</div>
<div class="line">    0 * 14 + 9,</div>
<div class="line">    6 * 3 + 1</div>
<div class="line">]</div>
<div class="line">= t[9, 19]</div>
</div><!-- fragment --><p> sharding = <code>[[0], [1]]</code> </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[m * (K ceildiv M) + k, n * (L ceildiv N) + l]</div>
<div class="line">t[i, j] -&gt; d(i floordiv (K ceildiv M), j floordiv (L ceildiv N))[i % (K ceildiv M), j % (L ceildiv N)]</div>
</div><!-- fragment --><p> sharding = <code>[[1], [0]]</code> </p><div class="fragment"><div class="line">d(m, n)[k, l] -&gt; t[n * (K ceildiv N) + k, m * (L ceildiv M) + l]</div>
<div class="line">t[i, j] -&gt; d(j floordiv (L ceildiv M), i floordiv (K ceildiv N))[i % (K ceildiv N), j % (L ceildiv M)]</div>
</div><!-- fragment --><p> sharding <code>[[0], [1]] -&gt; [[1], [0]]</code> <code>d1(m, n)</code> the tensor on device <code>(m, n)</code> for sharding sharding <code>[[0], [1]]</code>. <code>d2(m, n)</code> the tensor on device <code>(m, n)</code> for sharding sharding <code>[[1], [0]]</code>. </p><div class="fragment"><div class="line">d1(m, n)[k, l] -&gt;</div>
<div class="line">t[m * (K ceildiv M) + k, n * (L ceildiv N) + l] -&gt;</div>
<div class="line">d2(</div>
<div class="line">    (m * (L ceildiv M) + l) floordiv (L ceildiv M),</div>
<div class="line">    (n * (K ceildiv N) + k) floordiv (K ceildiv N)</div>
<div class="line">)[</div>
<div class="line">    (n * (K ceildiv N) + k) % (K ceildiv N),</div>
<div class="line">    (m * (L ceildiv M) + l) % (L ceildiv M)</div>
<div class="line">]</div>
<div class="line">= d2(p, q)[u, v]</div>
</div><!-- fragment --><p> We want to copy the the data between devices in slices/tiles. What are the source/target tile coordinates? For a fixed <code>(m, n, p, q)</code> what is the range of <code>(k, l, u, v)</code>? TODO</p>
<hr  />
<p>Reshard <code>KxL</code> tensor from sharding <code>[[0], [1]]</code> to sharding <code>[[1], [0]]</code> on a <code>2x3</code> shard.</p>
<p>Device placement on a <code>2x3</code> grid </p><div class="fragment"><div class="line">11 12 13  &lt;- devices</div>
<div class="line">21 22 23</div>
</div><!-- fragment --><p> sharding <code>[[0], [1]]</code> </p><div class="fragment"><div class="line">tensor axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+----+ tensor axis 0 |</div>
<div class="line">| 11 | 12 | 13 |               |</div>
<div class="line">+----+----+----+               |</div>
<div class="line">| 21 | 22 | 23 |               |</div>
<div class="line">+----+----+----+               ↓</div>
</div><!-- fragment --><p> transform to sharding <code>[[1], [0]]</code> </p><div class="fragment"><div class="line">tensor axis 1</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+ tensor axis 0 |</div>
<div class="line">| 11 | 21 |               |</div>
<div class="line">+----+----+               |</div>
<div class="line">| 12 | 22 |               |</div>
<div class="line">+----+----+               |</div>
<div class="line">| 13 | 23 |               |</div>
<div class="line">+----+----+               ↓</div>
</div><!-- fragment --> <div class="fragment"><div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|       11        |        12       |        13       |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|       21        |        22       |        23       |</div>
<div class="line">+                 +                 +                 +</div>
<div class="line">|                 |                 |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line"> </div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                          |                          |</div>
<div class="line">+          11              +               21         +</div>
<div class="line">|                          |                          |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                          |                          |</div>
<div class="line">+          12              +               22         +</div>
<div class="line">|                          |                          |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                          |                          |</div>
<div class="line">+          13              +               23         +</div>
<div class="line">|                          |                          |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line"> </div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+     11  11      + 12  11 + 12  21 +     13  21      +</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|     11  12      | 12  12 | 12  22 |     13  22      |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|     21  12      | 22  12 | 22  22 |     23  22      |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+     21  13      + 22  13 + 22  23 +     23  23      +</div>
<div class="line">|                 |        |        |                 |</div>
<div class="line">+-----------------+--------+--------+-----------------+</div>
</div><!-- fragment --><p> If <code>S</code> and <code>T</code> are the source and target shard sizes along some tensor axis. Then we have a period of <code>(S*T)/gcd(S, T)</code>. Then the cut pattern repeats. TODO</p>
<hr  />
<p>Reshard <code>6x6</code> tensor from sharding <code>[[0], []]</code> to sharding <code>[[], [0]]</code> on a <code>3</code> shard.</p>
<p>unsharded <code>6x6</code> tensor </p><div class="fragment"><div class="line">11 12 13 14 15 16</div>
<div class="line">21 22 23 24 25 26</div>
<div class="line">31 32 33 34 35 36</div>
<div class="line">41 42 43 44 45 46</div>
<div class="line">51 52 53 54 55 56</div>
<div class="line">61 62 63 64 65 66</div>
</div><!-- fragment --><p> sharded on a <code>3</code> grid</p>
<p>sharding = <code>[[0], []]</code> </p><div class="fragment"><div class="line">+-------------------+ grid axis 0 |</div>
<div class="line">| 11 12 13 14 15 16 |             |</div>
<div class="line">| 21 22 23 24 25 26 |             |</div>
<div class="line">+-------------------+             |</div>
<div class="line">| 31 32 33 34 35 36 |             |</div>
<div class="line">| 41 42 43 44 45 46 |             |</div>
<div class="line">+-------------------+             |</div>
<div class="line">| 51 52 53 54 55 56 |             |</div>
<div class="line">| 61 62 63 64 65 66 |             |</div>
<div class="line">+-------------------+             ↓</div>
</div><!-- fragment --><p> transform to sharding = <code>[[], [0]]</code> </p><div class="fragment"><div class="line">grid axis 0</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+-------+</div>
<div class="line">| 11 12 | 13 14 | 15 16 |</div>
<div class="line">| 21 22 | 23 24 | 25 26 |</div>
<div class="line">| 31 32 | 33 34 | 35 36 |</div>
<div class="line">| 41 42 | 43 44 | 45 46 |</div>
<div class="line">| 51 52 | 53 54 | 55 56 |</div>
<div class="line">| 61 62 | 63 64 | 65 66 |</div>
<div class="line">+-------+-------+-------+</div>
</div><!-- fragment --><p> Algorithm: </p>
<h1><a class="anchor" id="autotoc_md15"></a>
@code{mlir}</h1>
<p>%1 = all_to_all %0 on @grid grid_axes = [0] split_axis = 1 concat_axis = 0 : tensor&lt;2x6xi8&gt; -&gt; tensor&lt;6x2xi8&gt; </p>
<p>Reshard <code>4x4</code> tensor from sharding <code>[[0], [1, 2]]</code> to sharding <code>[[0, 1], [2]]</code> on a <code>2x2x2</code> shard.</p>
<p>unsharded <code>4x4</code> tensor </p><div class="fragment"><div class="line">11 12 13 14</div>
<div class="line">21 22 23 24</div>
<div class="line">31 32 33 34</div>
<div class="line">41 42 43 44</div>
</div><!-- fragment --><p> sharded on a <code>2x2x2</code> grid</p>
<p>sharding = <code>[[0], [1, 2]]</code> </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+----+----+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 | 12 |             |             |</div>
<div class="line">| 21 | 22 |             |             |</div>
<div class="line">+----+----+             |             |</div>
<div class="line">| 13 | 14 |             |             |</div>
<div class="line">| 23 | 24 |             |             |</div>
<div class="line">+----+----+             ↓             |</div>
<div class="line">+----+----+                           |</div>
<div class="line">| 31 | 32 |                           |</div>
<div class="line">| 41 | 42 |                           |</div>
<div class="line">+----+----+                           |</div>
<div class="line">| 33 | 34 |                           |</div>
<div class="line">| 43 | 44 |                           |</div>
<div class="line">+----+----+                           ↓</div>
</div><!-- fragment --><p> transform to sharding = <code>[[0, 1], [2]]</code> </p><div class="fragment"><div class="line">grid axis 2</div>
<div class="line">-----------&gt;</div>
<div class="line">+-------+-------+ grid axis 1 | grid axis 0 |</div>
<div class="line">| 11 12 | 13 41 |             |             |</div>
<div class="line">+-------+-------+             |             |</div>
<div class="line">| 21 22 | 23 24 |             |             |</div>
<div class="line">+-------+-------+             ↓             |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 31 32 | 33 34 |                           |</div>
<div class="line">+-------+-------+                           |</div>
<div class="line">| 41 42 | 43 44 |                           |</div>
<div class="line">+-------+-------+                           ↓</div>
</div><!-- fragment --><p> Algorithm: </p><div class="fragment"><div class="line">%1 = all_to_all %0 on @grid grid_axes = [2] split_axis = 1 concat_axis = 0 : tensor&lt;2x1xi8&gt; -&gt; tensor&lt;1x2xi8&gt;</div>
</div><!-- fragment --><p> is not enough.</p>
<p>Can be decomposed into </p><div class="fragment"><div class="line">[[0], [1, 2]] -&gt; [[0], [2, 1]] -&gt; [[0, 1], [2]]</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md16"></a>
Decomposition into basis of reshardings</h1>
<p>We can decompose each resharding into a sequence of basis reshardings. It is not communication efficient in terms of minimizing the data communicated between devices. An efficient approach would be more complicated to implement. Each device has to receive at most as much data as the size of its target sharding tensor.</p>
<hr  />
<p>Basis:</p>
<ul>
<li>From replicate to split. ``` [[]] -&gt; [[1]] ``` Extract slices without communication.</li>
<li>From split to replicate. ``` [[0]] -&gt; [[]] [[0, 1]] -&gt; [[1]] ``` All-gather along grid axis 0.</li>
<li>Swap grid axes order when assigned to the same tensor axis. ``` [[0, 1]] -&gt; [[1, 0]] ``` Swap contents on devices with the same linear index.</li>
<li>Move grid axis to different tensor dimension. ``` [[0], []] -&gt; [[], [0]] ``` All-to-all.</li>
</ul>
<hr  />
<p>Example decomposition of </p><div class="fragment"><div class="line">[[0], [1]] -&gt; [[1], [0]]</div>
</div><!-- fragment --><p> into </p><div class="fragment"><div class="line">[[0], [1]] -&gt; all-gather along grid axis 1    -&gt;</div>
<div class="line">[[0], []]  -&gt; all-to-all along grid axis 0    -&gt;</div>
<div class="line">[[], [0]]  -&gt; extract slice along grid axis 1 -&gt;</div>
<div class="line">[[1], [0]]</div>
</div><!-- fragment --><hr  />
<p>Example decomposition of </p><div class="fragment"><div class="line">[[3, 2], [], [0, 1]] -&gt; [[0], [1, 2], []]</div>
</div><!-- fragment --><p> into </p><div class="fragment"><div class="line">[[3, 2], [], [0, 1]] -&gt; all-to-all along grid axis 1 -&gt;</div>
<div class="line">[[3, 2], [1], [0]]   -&gt; all-to-all along grid axis 2 -&gt;</div>
<div class="line">[[3], [1, 2], [0]]   -&gt; all-gather along grid axis 3 -&gt;</div>
<div class="line">[[], [1, 2], [0]]    -&gt; all-to-all along grid axis 0 -&gt;</div>
<div class="line">[[0], [1, 2], []]</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Sep 27 2025 16:33:09 for MLIR by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
